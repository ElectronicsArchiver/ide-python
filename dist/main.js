"use strict";

var _main = require("./debugger/main");

const {
  shell
} = require("electron");

const whichSync = require("which").sync;

const {
  AutoLanguageClient
} = require("atom-languageclient");

const {
  detectVirtualEnv,
  detectPipEnv,
  replacePipEnvPathVar,
  sanitizeConfig
} = require("./utils");

// Ref: https://github.com/nteract/hydrogen/blob/master/lib/autocomplete-provider.js#L33
// adapted from http://stackoverflow.com/q/5474008
const PYTHON_REGEX = /(([^\W\d]|[\u00A0-\uFFFF])[\w.\u00A0-\uFFFF]*)|\.$/;

class PythonLanguageClient extends AutoLanguageClient {
  activate() {
    super.activate();

    if (!atom.packages.isPackageLoaded("atom-ide-base")) {
      // install if not installed
      // eslint-disable-next-line @typescript-eslint/no-var-requires
      require("atom-package-deps").install("ide-python", true).then(() => {
        // enable if disabled
        atom.packages.enablePackage("atom-ide-base");
        atom.notifications.addSuccess("ide-pyhon: atom-ide-base was installed and enabled...");
      });
    } // Remove deprecated option


    atom.config.unset("ide-python.pylsPath");
    (0, _main.activate)();
  }
  /* eslint-disable class-methods-use-this */


  getGrammarScopes() {
    return ["source.python", "python"];
  }

  getLanguageName() {
    return "Python";
  }

  getServerName() {
    return "pyls";
  }

  getRootConfigurationKey() {
    return "ide-python";
  }

  mapConfigurationObject(configuration) {
    return {
      pyls: {
        configurationSources: configuration.pylsConfigurationSources,
        rope: sanitizeConfig(configuration.rope),
        plugins: configuration.pylsPlugins
      }
    };
  }
  /* eslint-enable class-methods-use-this */


  async startServerProcess(projectPath) {
    const venvPath = (await detectPipEnv(projectPath)) || (await detectVirtualEnv(projectPath));
    const pylsEnvironment = Object.assign({}, process.env);

    if (venvPath) {
      pylsEnvironment.VIRTUAL_ENV = venvPath;
    }

    let pythonBin = atom.config.get("ide-python.python") || "python3";

    if (whichSync(pythonBin, {
      nothrow: true
    }) === null) {
      pythonBin = "python";
    }

    this.python = replacePipEnvPathVar(pythonBin, venvPath);
    let pyls = atom.config.get("ide-python.pyls") || "pylsp"; // check if it exists

    if (whichSync(pyls, {
      nothrow: true
    }) === null) {
      pyls = "pyls";
    }

    const childProcess = super.spawn(this.python, ["-m", pyls], {
      cwd: projectPath,
      env: pylsEnvironment
    });
    return childProcess;
  }

  onSpawnError(err) {
    const description = err.code === "ENOENT" ? `No Python interpreter found at \`${this.python}\`.` : `Could not spawn the Python interpreter \`${this.python}\`.`;
    atom.notifications.addError("`ide-python` could not launch your Python runtime.", {
      dismissable: true,
      description: `${description}<p>If you have Python installed please set "Python Executable" setting correctly. If you do not please install Python.</p>`
    });
  }

  onSpawnClose(code, signal) {
    if (code !== 0 && signal === null) {
      atom.notifications.addError("Unable to start the Python language server.", {
        dismissable: true,
        buttons: [{
          text: "Install Instructions",
          onDidClick: () => atom.workspace.open("atom://config/packages/ide-python")
        }, {
          text: "Download Python",
          onDidClick: () => shell.openExternal("https://www.python.org/downloads/")
        }],
        description: "Make sure to install `pylsp` 0.19 or newer by running:\n" + "```\n" + `${this.python} -m pip install 'python-lsp-server[all]'\n` + `${this.python} -m pip install git+https://github.com/tomv564/pyls-mypy.git\n` + "```"
      });
    }
  }

  getSuggestions(request) {
    if (!PYTHON_REGEX.test(request.prefix)) {
      return null;
    }

    return super.getSuggestions(request);
  }

  deactivate() {
    (0, _main.dispose)();
    return Promise.race([super.deactivate(), this.createTimeoutPromise(2000)]);
  }

  createTimeoutPromise(milliseconds) {
    return new Promise(resolve => {
      const timeout = setTimeout(() => {
        clearTimeout(timeout);
        this.logger.error(`Server failed to shutdown in ${milliseconds}ms, forcing termination`);
        resolve();
      }, milliseconds);
    });
  }

}

const pythonClient = new PythonLanguageClient();
pythonClient.createDebuggerProvider = _main.createDebuggerProvider; // add the debugger

module.exports = pythonClient;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1haW4uanMiXSwibmFtZXMiOlsic2hlbGwiLCJyZXF1aXJlIiwid2hpY2hTeW5jIiwic3luYyIsIkF1dG9MYW5ndWFnZUNsaWVudCIsImRldGVjdFZpcnR1YWxFbnYiLCJkZXRlY3RQaXBFbnYiLCJyZXBsYWNlUGlwRW52UGF0aFZhciIsInNhbml0aXplQ29uZmlnIiwiUFlUSE9OX1JFR0VYIiwiUHl0aG9uTGFuZ3VhZ2VDbGllbnQiLCJhY3RpdmF0ZSIsImF0b20iLCJwYWNrYWdlcyIsImlzUGFja2FnZUxvYWRlZCIsImluc3RhbGwiLCJ0aGVuIiwiZW5hYmxlUGFja2FnZSIsIm5vdGlmaWNhdGlvbnMiLCJhZGRTdWNjZXNzIiwiY29uZmlnIiwidW5zZXQiLCJnZXRHcmFtbWFyU2NvcGVzIiwiZ2V0TGFuZ3VhZ2VOYW1lIiwiZ2V0U2VydmVyTmFtZSIsImdldFJvb3RDb25maWd1cmF0aW9uS2V5IiwibWFwQ29uZmlndXJhdGlvbk9iamVjdCIsImNvbmZpZ3VyYXRpb24iLCJweWxzIiwiY29uZmlndXJhdGlvblNvdXJjZXMiLCJweWxzQ29uZmlndXJhdGlvblNvdXJjZXMiLCJyb3BlIiwicGx1Z2lucyIsInB5bHNQbHVnaW5zIiwic3RhcnRTZXJ2ZXJQcm9jZXNzIiwicHJvamVjdFBhdGgiLCJ2ZW52UGF0aCIsInB5bHNFbnZpcm9ubWVudCIsIk9iamVjdCIsImFzc2lnbiIsInByb2Nlc3MiLCJlbnYiLCJWSVJUVUFMX0VOViIsInB5dGhvbkJpbiIsImdldCIsIm5vdGhyb3ciLCJweXRob24iLCJjaGlsZFByb2Nlc3MiLCJzcGF3biIsImN3ZCIsIm9uU3Bhd25FcnJvciIsImVyciIsImRlc2NyaXB0aW9uIiwiY29kZSIsImFkZEVycm9yIiwiZGlzbWlzc2FibGUiLCJvblNwYXduQ2xvc2UiLCJzaWduYWwiLCJidXR0b25zIiwidGV4dCIsIm9uRGlkQ2xpY2siLCJ3b3Jrc3BhY2UiLCJvcGVuIiwib3BlbkV4dGVybmFsIiwiZ2V0U3VnZ2VzdGlvbnMiLCJyZXF1ZXN0IiwidGVzdCIsInByZWZpeCIsImRlYWN0aXZhdGUiLCJQcm9taXNlIiwicmFjZSIsImNyZWF0ZVRpbWVvdXRQcm9taXNlIiwibWlsbGlzZWNvbmRzIiwicmVzb2x2ZSIsInRpbWVvdXQiLCJzZXRUaW1lb3V0IiwiY2xlYXJUaW1lb3V0IiwibG9nZ2VyIiwiZXJyb3IiLCJweXRob25DbGllbnQiLCJjcmVhdGVEZWJ1Z2dlclByb3ZpZGVyIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7QUFLQTs7QUFMQSxNQUFNO0FBQUVBLEVBQUFBO0FBQUYsSUFBWUMsT0FBTyxDQUFDLFVBQUQsQ0FBekI7O0FBQ0EsTUFBTUMsU0FBUyxHQUFHRCxPQUFPLENBQUMsT0FBRCxDQUFQLENBQWlCRSxJQUFuQzs7QUFDQSxNQUFNO0FBQUVDLEVBQUFBO0FBQUYsSUFBeUJILE9BQU8sQ0FBQyxxQkFBRCxDQUF0Qzs7QUFDQSxNQUFNO0FBQUVJLEVBQUFBLGdCQUFGO0FBQW9CQyxFQUFBQSxZQUFwQjtBQUFrQ0MsRUFBQUEsb0JBQWxDO0FBQXdEQyxFQUFBQTtBQUF4RCxJQUEyRVAsT0FBTyxDQUFDLFNBQUQsQ0FBeEY7O0FBSUE7QUFDQTtBQUNBLE1BQU1RLFlBQVksR0FBRyxvREFBckI7O0FBRUEsTUFBTUMsb0JBQU4sU0FBbUNOLGtCQUFuQyxDQUFzRDtBQUNwRE8sRUFBQUEsUUFBUSxHQUFHO0FBQ1QsVUFBTUEsUUFBTjs7QUFDQSxRQUFJLENBQUNDLElBQUksQ0FBQ0MsUUFBTCxDQUFjQyxlQUFkLENBQThCLGVBQTlCLENBQUwsRUFBcUQ7QUFDbkQ7QUFDQTtBQUNBYixNQUFBQSxPQUFPLENBQUMsbUJBQUQsQ0FBUCxDQUNHYyxPQURILENBQ1csWUFEWCxFQUN5QixJQUR6QixFQUVHQyxJQUZILENBRVEsTUFBTTtBQUNWO0FBQ0FKLFFBQUFBLElBQUksQ0FBQ0MsUUFBTCxDQUFjSSxhQUFkLENBQTRCLGVBQTVCO0FBQ0FMLFFBQUFBLElBQUksQ0FBQ00sYUFBTCxDQUFtQkMsVUFBbkIsQ0FB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QixZQUFNQyxPQUFPLEdBQUdDLFVBQVUsQ0FBQyxNQUFNO0FBQy9CQyxRQUFBQSxZQUFZLENBQUNGLE9BQUQsQ0FBWjtBQUNBLGFBQUtHLE1BQUwsQ0FBWUMsS0FBWixDQUFtQixnQ0FBK0JOLFlBQWEseUJBQS9EO0FBQ0FDLFFBQUFBLE9BQU87QUFDUixPQUp5QixFQUl2QkQsWUFKdUIsQ0FBMUI7QUFLRCxLQU5NLENBQVA7QUFPRDs7QUFqSW1EOztBQW9JdEQsTUFBTU8sWUFBWSxHQUFHLElBQUlyRSxvQkFBSixFQUFyQjtBQUNBcUUsWUFBWSxDQUFDQyxzQkFBYixHQUFzQ0EsNEJBQXRDLEMsQ0FBNkQ7O0FBQzdEQyxNQUFNLENBQUNDLE9BQVAsR0FBaUJILFlBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgeyBzaGVsbCB9ID0gcmVxdWlyZShcImVsZWN0cm9uXCIpXG5jb25zdCB3aGljaFN5bmMgPSByZXF1aXJlKFwid2hpY2hcIikuc3luY1xuY29uc3QgeyBBdXRvTGFuZ3VhZ2VDbGllbnQgfSA9IHJlcXVpcmUoXCJhdG9tLWxhbmd1YWdlY2xpZW50XCIpXG5jb25zdCB7IGRldGVjdFZpcnR1YWxFbnYsIGRldGVjdFBpcEVudiwgcmVwbGFjZVBpcEVudlBhdGhWYXIsIHNhbml0aXplQ29uZmlnIH0gPSByZXF1aXJlKFwiLi91dGlsc1wiKVxuXG5pbXBvcnQgeyBjcmVhdGVEZWJ1Z2dlclByb3ZpZGVyLCBhY3RpdmF0ZSBhcyBkZWJ1Z2dlckFjdGl2YXRlLCBkaXNwb3NlIGFzIGRlYnVnZ2VyRGlzcG9zZSB9IGZyb20gXCIuL2RlYnVnZ2VyL21haW5cIlxuXG4vLyBSZWY6IGh0dHBzOi8vZ2l0aHViLmNvbS9udGVyYWN0L2h5ZHJvZ2VuL2Jsb2IvbWFzdGVyL2xpYi9hdXRvY29tcGxldGUtcHJvdmlkZXIuanMjTDMzXG4vLyBhZGFwdGVkIGZyb20gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3EvNTQ3NDAwOFxuY29uc3QgUFlUSE9OX1JFR0VYID0gLygoW15cXFdcXGRdfFtcXHUwMEEwLVxcdUZGRkZdKVtcXHcuXFx1MDBBMC1cXHVGRkZGXSopfFxcLiQvXG5cbmNsYXNzIFB5dGhvbkxhbmd1YWdlQ2xpZW50IGV4dGVuZHMgQXV0b0xhbmd1YWdlQ2xpZW50IHtcbiAgYWN0aXZhdGUoKSB7XG4gICAgc3VwZXIuYWN0aXZhdGUoKVxuICAgIGlmICghYXRvbS5wYWNrYWdlcy5pc1BhY2thZ2VMb2FkZWQoXCJhdG9tLWlkZS1iYXNlXCIpKSB7XG4gICAgICAvLyBpbnN0YWxsIGlmIG5vdCBpbnN0YWxsZWRcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdmFyLXJlcXVpcmVzXG4gICAgICByZXF1aXJlKFwiYXRvbS1wYWNrYWdlLWRlcHNcIilcbiAgICAgICAgLmluc3RhbGwoXCJpZGUtcHl0aG9uXCIsIHRydWUpXG4gICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAvLyBlbmFibGUgaWYgZGlzYWJsZWRcbiAgICAgICAgICBhdG9tLnBhY2thZ2VzLmVuYWJsZVBhY2thZ2UoXCJhdG9tLWlkZS1iYXNlXCIpXG4gICAgICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZFN1Y2Nlc3MoXCJpZGUtcHlob246IGF0b20taWRlLWJhc2Ugd2FzIGluc3RhbGxlZCBhbmQgZW5hYmxlZC4uLlwiKVxuICAgICAgICB9KVxuICAgIH1cbiAgICAvLyBSZW1vdmUgZGVwcmVjYXRlZCBvcHRpb25cbiAgICBhdG9tLmNvbmZpZy51bnNldChcImlkZS1weXRob24ucHlsc1BhdGhcIilcbiAgICBkZWJ1Z2dlckFjdGl2YXRlKClcbiAgfVxuXG4gIC8qIGVzbGludC1kaXNhYmxlIGNsYXNzLW1ldGhvZHMtdXNlLXRoaXMgKi9cbiAgZ2V0R3JhbW1hclNjb3BlcygpIHtcbiAgICByZXR1cm4gW1wic291cmNlLnB5dGhvblwiLCBcInB5dGhvblwiXVxuICB9XG5cbiAgZ2V0TGFuZ3VhZ2VOYW1lKCkge1xuICAgIHJldHVybiBcIlB5dGhvblwiXG4gIH1cblxuICBnZXRTZXJ2ZXJOYW1lKCkge1xuICAgIHJldHVybiBcInB5bHNcIlxuICB9XG5cbiAgZ2V0Um9vdENvbmZpZ3VyYXRpb25LZXkoKSB7XG4gICAgcmV0dXJuIFwiaWRlLXB5dGhvblwiXG4gIH1cblxuICBtYXBDb25maWd1cmF0aW9uT2JqZWN0KGNvbmZpZ3VyYXRpb24pIHtcbiAgICByZXR1cm4ge1xuICAgICAgcHlsczoge1xuICAgICAgICBjb25maWd1cmF0aW9uU291cmNlczogY29uZmlndXJhdGlvbi5weWxzQ29uZmlndXJhdGlvblNvdXJjZXMsXG4gICAgICAgIHJvcGU6IHNhbml0aXplQ29uZmlnKGNvbmZpZ3VyYXRpb24ucm9wZSksXG4gICAgICAgIHBsdWdpbnM6IGNvbmZpZ3VyYXRpb24ucHlsc1BsdWdpbnMsXG4gICAgICB9LFxuICAgIH1cbiAgfVxuICAvKiBlc2xpbnQtZW5hYmxlIGNsYXNzLW1ldGhvZHMtdXNlLXRoaXMgKi9cblxuICBhc3luYyBzdGFydFNlcnZlclByb2Nlc3MocHJvamVjdFBhdGgpIHtcbiAgICBjb25zdCB2ZW52UGF0aCA9IChhd2FpdCBkZXRlY3RQaXBFbnYocHJvamVjdFBhdGgpKSB8fCAoYXdhaXQgZGV0ZWN0VmlydHVhbEVudihwcm9qZWN0UGF0aCkpXG4gICAgY29uc3QgcHlsc0Vudmlyb25tZW50ID0gT2JqZWN0LmFzc2lnbih7fSwgcHJvY2Vzcy5lbnYpXG4gICAgaWYgKHZlbnZQYXRoKSB7XG4gICAgICBweWxzRW52aXJvbm1lbnQuVklSVFVBTF9FTlYgPSB2ZW52UGF0aFxuICAgIH1cblxuICAgIGxldCBweXRob25CaW4gPSBhdG9tLmNvbmZpZy5nZXQoXCJpZGUtcHl0aG9uLnB5dGhvblwiKSB8fCBcInB5dGhvbjNcIlxuICAgIGlmICh3aGljaFN5bmMocHl0aG9uQmluLCB7IG5vdGhyb3c6IHRydWUgfSkgPT09IG51bGwpIHtcbiAgICAgIHB5dGhvbkJpbiA9IFwicHl0aG9uXCJcbiAgICB9XG5cbiAgICB0aGlzLnB5dGhvbiA9IHJlcGxhY2VQaXBFbnZQYXRoVmFyKHB5dGhvbkJpbiwgdmVudlBhdGgpXG5cbiAgICBsZXQgcHlscyA9IGF0b20uY29uZmlnLmdldChcImlkZS1weXRob24ucHlsc1wiKSB8fCBcInB5bHNwXCJcbiAgICAvLyBjaGVjayBpZiBpdCBleGlzdHNcbiAgICBpZiAod2hpY2hTeW5jKHB5bHMsIHsgbm90aHJvdzogdHJ1ZSB9KSA9PT0gbnVsbCkge1xuICAgICAgcHlscyA9IFwicHlsc1wiXG4gICAgfVxuXG4gICAgY29uc3QgY2hpbGRQcm9jZXNzID0gc3VwZXIuc3Bhd24odGhpcy5weXRob24sIFtcIi1tXCIsIHB5bHNdLCB7XG4gICAgICBjd2Q6IHByb2plY3RQYXRoLFxuICAgICAgZW52OiBweWxzRW52aXJvbm1lbnQsXG4gICAgfSlcbiAgICByZXR1cm4gY2hpbGRQcm9jZXNzXG4gIH1cblxuICBvblNwYXduRXJyb3IoZXJyKSB7XG4gICAgY29uc3QgZGVzY3JpcHRpb24gPVxuICAgICAgZXJyLmNvZGUgPT09IFwiRU5PRU5UXCJcbiAgICAgICAgPyBgTm8gUHl0aG9uIGludGVycHJldGVyIGZvdW5kIGF0IFxcYCR7dGhpcy5weXRob259XFxgLmBcbiAgICAgICAgOiBgQ291bGQgbm90IHNwYXduIHRoZSBQeXRob24gaW50ZXJwcmV0ZXIgXFxgJHt0aGlzLnB5dGhvbn1cXGAuYFxuICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihcImBpZGUtcHl0aG9uYCBjb3VsZCBub3QgbGF1bmNoIHlvdXIgUHl0aG9uIHJ1bnRpbWUuXCIsIHtcbiAgICAgIGRpc21pc3NhYmxlOiB0cnVlLFxuICAgICAgZGVzY3JpcHRpb246IGAke2Rlc2NyaXB0aW9ufTxwPklmIHlvdSBoYXZlIFB5dGhvbiBpbnN0YWxsZWQgcGxlYXNlIHNldCBcIlB5dGhvbiBFeGVjdXRhYmxlXCIgc2V0dGluZyBjb3JyZWN0bHkuIElmIHlvdSBkbyBub3QgcGxlYXNlIGluc3RhbGwgUHl0aG9uLjwvcD5gLFxuICAgIH0pXG4gIH1cblxuICBvblNwYXduQ2xvc2UoY29kZSwgc2lnbmFsKSB7XG4gICAgaWYgKGNvZGUgIT09IDAgJiYgc2lnbmFsID09PSBudWxsKSB7XG4gICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoXCJVbmFibGUgdG8gc3RhcnQgdGhlIFB5dGhvbiBsYW5ndWFnZSBzZXJ2ZXIuXCIsIHtcbiAgICAgICAgZGlzbWlzc2FibGU6IHRydWUsXG4gICAgICAgIGJ1dHRvbnM6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICB0ZXh0OiBcIkluc3RhbGwgSW5zdHJ1Y3Rpb25zXCIsXG4gICAgICAgICAgICBvbkRpZENsaWNrOiAoKSA9PiBhdG9tLndvcmtzcGFjZS5vcGVuKFwiYXRvbTovL2NvbmZpZy9wYWNrYWdlcy9pZGUtcHl0aG9uXCIpLFxuICAgICAgICAgIH0sXG4gICAgICAgICAge1xuICAgICAgICAgICAgdGV4dDogXCJEb3dubG9hZCBQeXRob25cIixcbiAgICAgICAgICAgIG9uRGlkQ2xpY2s6ICgpID0+IHNoZWxsLm9wZW5FeHRlcm5hbChcImh0dHBzOi8vd3d3LnB5dGhvbi5vcmcvZG93bmxvYWRzL1wiKSxcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgICBkZXNjcmlwdGlvbjpcbiAgICAgICAgICBcIk1ha2Ugc3VyZSB0byBpbnN0YWxsIGBweWxzcGAgMC4xOSBvciBuZXdlciBieSBydW5uaW5nOlxcblwiICtcbiAgICAgICAgICBcImBgYFxcblwiICtcbiAgICAgICAgICBgJHt0aGlzLnB5dGhvbn0gLW0gcGlwIGluc3RhbGwgJ3B5dGhvbi1sc3Atc2VydmVyW2FsbF0nXFxuYCArXG4gICAgICAgICAgYCR7dGhpcy5weXRob259IC1tIHBpcCBpbnN0YWxsIGdpdCtodHRwczovL2dpdGh1Yi5jb20vdG9tdjU2NC9weWxzLW15cHkuZ2l0XFxuYCArXG4gICAgICAgICAgXCJgYGBcIixcbiAgICAgIH0pXG4gICAgfVxuICB9XG5cbiAgZ2V0U3VnZ2VzdGlvbnMocmVxdWVzdCkge1xuICAgIGlmICghUFlUSE9OX1JFR0VYLnRlc3QocmVxdWVzdC5wcmVmaXgpKSB7XG4gICAgICByZXR1cm4gbnVsbFxuICAgIH1cbiAgICByZXR1cm4gc3VwZXIuZ2V0U3VnZ2VzdGlvbnMocmVxdWVzdClcbiAgfVxuXG4gIGRlYWN0aXZhdGUoKSB7XG4gICAgZGVidWdnZXJEaXNwb3NlKClcbiAgICByZXR1cm4gUHJvbWlzZS5yYWNlKFtzdXBlci5kZWFjdGl2YXRlKCksIHRoaXMuY3JlYXRlVGltZW91dFByb21pc2UoMjAwMCldKVxuICB9XG5cbiAgY3JlYXRlVGltZW91dFByb21pc2UobWlsbGlzZWNvbmRzKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG4gICAgICBjb25zdCB0aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KVxuICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihgU2VydmVyIGZhaWxlZCB0byBzaHV0ZG93biBpbiAke21pbGxpc2Vjb25kc31tcywgZm9yY2luZyB0ZXJtaW5hdGlvbmApXG4gICAgICAgIHJlc29sdmUoKVxuICAgICAgfSwgbWlsbGlzZWNvbmRzKVxuICAgIH0pXG4gIH1cbn1cblxuY29uc3QgcHl0aG9uQ2xpZW50ID0gbmV3IFB5dGhvbkxhbmd1YWdlQ2xpZW50KClcbnB5dGhvbkNsaWVudC5jcmVhdGVEZWJ1Z2dlclByb3ZpZGVyID0gY3JlYXRlRGVidWdnZXJQcm92aWRlciAvLyBhZGQgdGhlIGRlYnVnZ2VyXG5tb2R1bGUuZXhwb3J0cyA9IHB5dGhvbkNsaWVudFxuIl19